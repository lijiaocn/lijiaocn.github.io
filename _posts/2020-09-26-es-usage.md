---
layout: default
title: "ElasticSearch 基本概念和操作方法"
author: 李佶澳
date: "2020-09-26 17:12:42 +0800"
last_modified_at: "2020-09-26 17:12:42 +0800"
categories: 项目
cover: 
tags:  Elasticsearch
keywords: Elasticsearch,es
description: "Elasticsearch 的基本概念和基本使用方法，Index、Mapping 和 Document 概念和查询语句"
---

## 目录

* auto-gen TOC:
{:toc}

## 说明

Elasticsearch 是一个准实时的分布式搜索分析引擎，提供索引、搜索和分析功能。 Logstash、xxBeats 是配套的数据导入工具，Kibana 提供了可视化页面。

**学习资料：**

* [es官网文档][21]


## ES 的基本概念：Document、Index 和 Mapping

**Document**：一份序列化成 json 格式的文档数据，它由多个 filed 组成，每个 field 是一个 key-value。

**Index**： es 中的 Document 的组织单位，每个 Document 都隶属一个 Index。

**Mapping**： index 中记录 Document 的每个 filed 的数值类型。

与关系型数据库类比：

```
                   关系型数据库                     ES  
----------------------------------------------------------------------------
管理的数据单元     包含多个列的关系型行记录        包含多个k-v filed 的json 字符串
数据的组织单位     数据表                          Index 索引
数据类型描述       建表语句                        Index 的 Mapping
```

Document 的每个 field 可以使用不同的数据类型，es 根据 field 的类型使用不同的索引方式，例如：

1. text fields 存储在倒排索引中
2. numeric 和 geo 存储在 BKD tree 中

Mapping 可以手动创建，或者启用 dynamic mapping， 让 es 自动添加并推断 filed 的数据类型。

ES 的特点：

1. 文档数据（Document）写入后会在 1s 之内完成索引、可被搜索
2. 为 text 类型的 filed 建立「倒排索引/ inverted index」，支持快速的全文搜索


## 快速上手

Es 检查运行状态：

```sh
curl http://127.0.0.1:9200
```

### 创建 Index 

创建 Index 并设置 Mapping：

```sh
PUT /my-index-000001?pretty
{
  "mappings": {
    "properties": {
      "age":    { "type": "integer" },  
      "email":  { "type": "keyword"  }, 
      "name":   { "type": "text"  }     
    }
  }
}
```

PUT 上传的内容就是 Mapping，其中 age、email、name 是 Document 中的 filed 名称，type 是 filed 的数值类型。。

### 查看 Index 

**查看 es 中所有 index：**

```sh
GET /_cat/indices?v

health status index                          uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana-event-log-7.9.2-000001 BXulL2qmTTq2FYYOYdNqbQ   1   0          1            0      5.5kb          5.5kb
green  open   .apm-custom-link               CS8LkfBvRKGdSXjI0ky6tw   1   0          0            0       208b           208b
green  open   .kibana_task_manager_1         569Jhi3NS8etY8pYF4jxvg   1   0          6          267    136.2kb        136.2kb
green  open   kibana_sample_data_ecommerce   _6pu_ggDQCSLwL9jvrA-Fg   1   0       4675            0      4.7mb          4.7mb
green  open   .apm-agent-configuration       t9t6VR2KQi-YDewFQjI0Fw   1   0          0            0       208b           208b
green  open   .kibana_1                      pEI_2VXrTRagNq_fyWd5eg   1   0         75            1     12.6mb         12.6mb
yellow open   my-index-000001                6mmUoVrASWSTBWQjKDicqg   1   1          0            0       208b           208b
```

**查看 Index  my-index-000001 的 Mapping：**

```sh
GET  /my-index-000001/_mapping

{
  "my-index-000001" : {
    "mappings" : {
      "properties" : {
        "age" : {
          "type" : "integer"
        },
        "email" : {
          "type" : "keyword"
        },
        "name" : {
          "type" : "text"
        }
      }
    }
  }
}

```

### 写入 Document

`_doc` 是 ES 定义的接口路径，`1` 是要写入的 Document 的 id，Body 是 Document 内容：

```sh
PUT /my-index-000001/_doc/1
{
      "age":    11,  
      "email":  "xiaomang@mail.com", 
      "name":   "小王"   
}
```

### 查询 Document：通过 ID 查询

查询 ID 为 1 的 Document：

```sh
GET  /my-index-000001/_doc/1

{
  "_index" : "my-index-000001",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "_seq_no" : 0,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "age" : 11,
    "email" : "xiaomang@mail.com",
    "name" : "小王"
  }
}
```

返回的结果中带 `_` 前缀 filed 是 Document 的 Metadata fileds，ES 支持的 [Metadata fields][8] 列表：

### 查询 Document：通过 field 数值查找

查找年龄为 11 的 Document：

```sh
GET /my-index-000001/_search
{
  "query": {
    "term": {
      "age": 11
    }
  }
}
```

term 是查询语法中的关键字。

### 删除 Document 

```sh
DELETE /my-index-000001/_doc/1
{
  "_index" : "my-index-000001",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 6,
  "result" : "deleted",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 5,
  "_primary_term" : 1
}
```

数据已经删除：

```sh
GET /my-index-000001/_doc/1
{
  "_index" : "my-index-000001",
  "_type" : "_doc",
  "_id" : "1",
  "found" : false
}
```



## 更多操作

### Index 的自动创建 

ES 支持在写入的 document 的时候自动创建 index，不需要提前创建 index：

```sh
PUT /new-index-000001/_doc/1
{
      "age":    11,  
      "email":  "xiaomang@mail.com", 
      "name":   "小王"   
}

```

查看：

```
GET /new-index-000001/
```

### 批量写入Document

```sh
wget https://raw.githubusercontent.com/elastic/elasticsearch/master/docs/src/test/resources/accounts.json
curl -H "Content-Type: application/json" -XPOST "localhost:9200/banke/_bulk?pretty&refresh" --data-binary "@accounts.json"
```

### field 数值类型汇总

field 可以使用以下数据类型， 不同版本的 es 支持情况可能不同，详情见 [Field data types][7]：

**常规类型：**

1. binary
2. boolean
3. keywords
4. numbers
5. date/date_nanos
6. alias

**对象类型：**

1. object
2. flattened
3. nested
4. join

**结构化类型：**

1. range
2. ip
3. version
4. murmur3

**聚合数据类型：**

1. aggregate_metric_double
2. histogram

**搜索文本类型**：

1. text fields
2. annotated-text
3. completion
4. search_as_you_type
5. token_count

**文档排名类型**：

1. dense_vector
2. sparse_evctor
3. rank_feature
4. rank_features

**地理位置类型**：

1. geo_point
2. geo_shape
3. point
4. shape

**其它类型**：

1. percolator

**数组类型不需要专门定义，每个 filed 的数值都可以是一个数组列表**

一个 filed 可以被设置多种类型，以用于不同目的，这个特性叫做 [multi-fields][22]。

如下所示，city field 有两个类型 text 和 keyword：

```sh
PUT my-index-000001
{
  "mappings": {
    "properties": {
      "city": {
        "type": "text",           <-- 第一个类型
        "fields": {               <-- 在 fileds 中继续设置其它类型
          "raw": { 
            "type":  "keyword"   
          }
        }
      }
    }
  }
}
```

### field 的配置项汇总 

Mapping 中的 field 不止有 `type` 这一个配置项，还有很多其它功能的配置，譬如下的 `index`

为已有的 Index 增加属性设置，`_mapping`：

```sh
PUT /my-index-000001/_mapping
{
  "properties": {
    "employee-id": {
      "type": "keyword",
      "index": false         <-- false，不为 employee-id 创建索引
    }
  }
}
```

下面是 field 可用的配置项， 不同版本的 es 支持情况可能不同 [Mapping Parameters][6]：

```sh
analyzer
boost
coerce
copy_to
doc_values
dynamic
eager_global_ordinals
enabled
fielddata
fields
format
ignore_above
ignore_malformed
index_options
index_phrases
index_prefixes
index
meta
normalizer
norms
null_value
position_increment_gap
properties
search_analyzer
similarity
store
term_vector
```


### Document 的 Metadata fields

查询的 Document 的时候会发现，返回了很多带有 `_` 前缀的 field:

```sh
GET  /my-index-000001/_doc/1

{
  "_index" : "my-index-000001",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "_seq_no" : 0,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "age" : 11,
    "email" : "xiaomang@mail.com",
    "name" : "小王"
  }
}
```

ES 支持的 [Metadata fields][8] ：

```sh
_field_names field
_ignored field
_id field
_index field
_meta field
_routing field
_source field
_type field
```

## 文档查询语法

下面示例中使用的是 kibana 中的 Dev Tools 提供的 http 接口。

### 语句结构

ES 的查询语句分为查询条件 （query context） 和筛选条件（filter context） 两部分。

query 后面跟随的查询条件：

```sh
GET /banke/_search
{
  "query": { "match": { "address": "mill lane" } }
}
```

filter 后面跟随的过滤条件：

```sh
GET /bank/_search
{
  "query": {
    "bool": {
      "must": { "match_all": {} },
      "filter": {
        "range": {
          "balance": {
            "gte": 20000,
            "lte": 30000
          }
        }
      }
    }
  }
}
```

查询语句分为最小的查询语句`叶子语句`（Leaf query clauses） 和由叶子语句组成的`组合语句`（Compound query clauses）。

查询举例，ES query 语法见 [ES Query DSL][9]：

```sh
GET /banke/_search
{
  "query": { "match_all": {} },
  "sort": [
    { "account_number": "asc" }
  ],
  "from": 10,
  "size": 10
}
```

```sh
GET /banke/_search
{
  "query": {
    "bool": {
      "must": [
        { "match": { "age": "40" } }
      ],
      "must_not": [
        { "match": { "state": "ID" } }
      ]
    }
  }
}
```

### 语法：exists

精确匹配文档中的 field，ES 提供了多个 term level 级别的查询： [ES term level query][18]。

```sh
# 是否存在
GET /_search
{
  "query": {
    "exists": {
      "field": "user"
    }
  }
}
```

### 语法：fuzzy

```sh
# 近似值
GET /_search
{
  "query": {
    "fuzzy": {
      "user.id": {
        "value": "ki"
      }
    }
  }
}

```

### 语法：ids

```sh
# 按 id 查询
GET /_search
{
  "query": {
    "ids" : {
      "values" : ["1", "4", "100"]
    }
  }
}
```

### 语法：prefix

```sh
# 前缀匹配
GET /_search
{
  "query": {
    "prefix": {
      "user.id": {
        "value": "ki"
      }
    }
  }
}
```

### 语法：range

```sh
# 范围查找
GET /_search
{
  "query": {
    "range": {
      "age": {
        "gte": 10,
        "lte": 20,
        "boost": 2.0
      }
    }
  }
}
```

### 语法：regexp

```sh
# 正则匹配
GET /_search
{
  "query": {
    "regexp": {
      "user.id": {
        "value": "k.*y",
        "flags": "ALL",
        "max_determinized_states": 10000,
        "rewrite": "constant_score"
      }
    }
  }
}
```

### 语法：term

```sh
# field 值匹配
GET /_search
{
  "query": {
    "term": {
      "user.id": {
        "value": "kimchy",
        "boost": 1.0
      }
    }
  }
}

```

### 语法：terms

```sh
# field 值匹配
GET /_search
{
  "query": {
    "terms": {
      "user.id": [ "kimchy", "elkbee" ],
      "boost": 1.0
    }
  }
}
```

### 语法：terms_set

```sh
GET /job-candidates/_search
{
  "query": {
    "terms_set": {
      "programming_languages": {
        "terms": [ "c++", "java", "php" ],
        "minimum_should_match_field": "required_matches"
      }
    }
  }
}
```

### 语法：type

```sh
# 类型查询
GET /_search
{
  "query": {
    "type": {
      "value": "_doc"
    }
  }
}
```

### 语法：wildcard

```sh
# 通配符
GET /_search
{
  "query": {
    "wildcard": {
      "user.id": {
        "value": "ki*y",
        "boost": 1.0,
        "rewrite": "constant_score"
      }
    }
  }
}
```

### 语法：match_all / match_none

[ES match all query][17] 最简单的查询语句，所有的文档评分 1.0：

```sh
GET /_search
{
    "query": {
        "match_all": {}
    }
}
```

用 boost 修改默认的 1.0：

```sh
GET /_search
{
  "query": {
    "match_all": { "boost" : 1.2 }
  }
}
```

match_none 是 match_all 的取反：

```sh
GET /_search
{
  "query": {
    "match_none": {}
  }
}
```

### 语法：bool 

组合多个子查询语句，子查询语句的组合条件可以是 must、filter、should、must_not。

[ES Boolean query][12]：

```sh
POST _search
{
  "query": {
    "bool" : {
      "must" : {
        "term" : { "user.id" : "kimchy" }
      },
      "filter": {
        "term" : { "tags" : "production" }
      },
      "must_not" : {
        "range" : {
          "age" : { "gte" : 10, "lte" : 20 }
        }
      },
      "should" : [
        { "term" : { "tags" : "env1" } },
        { "term" : { "tags" : "deployed" } }
      ],
      "minimum_should_match" : 1,
      "boost" : 1.0
    }
  }
}
```

### 语法：boosting 

降低命中特定条件的文档的评分，[ES boosting query][13]：

```sh
GET /_search
{
  "query": {
    "boosting": {
      "positive": {
        "term": {
          "text": "apple"
        }
      },
      "negative": {
        "term": {
          "text": "pie tart fruit crumble tree"
        }
      },
      "negative_boost": 0.5
    }
  }
}
```

### 语法：constant_score

为匹配的文档设置固定的评分，[ES constant score][14]：

```sh
GET /_search
{
  "query": {
    "constant_score": {
      "filter": {
        "term": { "user.id": "kimchy" }
      },
      "boost": 1.2
    }
  }
}
```

### 语法：dis_max

[ES Disjunction max query][15] 

### 语法：function_score

[ES Function score query][16]


### 语法：match

指定多个 field 和期待的 value，然后通过 operator 等参数控制行为，[ES Match query][11]：

```sh
GET /_search
{
  "query": {
    "match": {
      "message": {
        "query": "this is a test",
        "operator": "and"
      }
    }
  }
}
```

### 语法：aggs

[ES Aggregation][10]

```sh
GET /bank/_search
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state.keyword"
      }
    }
  }
}
```

```sh
GET /bank/_search
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state.keyword"
      },
      "aggs": {
        "average_balance": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}
```

```sh
GET /bank/_search
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state.keyword",
        "order": {
          "average_balance": "desc"
        }
      },
      "aggs": {
        "average_balance": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}
```

## SQL 查询

[SQL查询][20]

## 参考

0. [李佶澳的博客][1]
1. [es官网文档][21]
2. [Install Kibana With Docker][2]
3. [Install Elasticsearch With Docker][3]
4. [Elastic Stack Doc][4]
5. [Running the Elastic Stack On Docker][5]
6. [Mapping Parameters][6]
7. [Mapping types][7]
8. [Metadata fields][8]
9. [ES Query DSL][9]
10. [ES Aggregation][10]
11. [ES Match query][11]
12. [ES Boolean query][12]
13. [ES boosting query][13]
14. [ES constant score][14]
15. [ES Disjunction max query][15]
16. [ES Function score query][16]
17. [ES match all query][17]
18. [ES term level query][18]
19. [ELK Stack 中文指南][19]
20. [SQL查询][20]

[1]: https://www.lijiaocn.com "李佶澳的博客"
[2]: https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html "Install Elasticsearch With Docker"
[3]: https://www.elastic.co/guide/en/kibana/current/docker.html "Install Kibana With Docker" 
[4]: https://www.elastic.co/guide/index.html "Elastic Stack Doc"
[5]: https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-docker.html "Running the Elastic Stack On Docker"
[6]: https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html "Mapping Parameters"
[7]: https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html "Mapping types"
[8]: https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-fields.html "Metadata fields"
[9]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html "ES Query DSL"
[10]: https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html "ES Aggregation"
[11]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html "ES Match query"
[12]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html  "ES Boolean query"
[13]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-boosting-query.html "ES boosting query"
[14]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-constant-score-query.html "ES constant score"
[15]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-dis-max-query.html  "ES Disjunction max query"
[16]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html "ES Function score query"
[17]: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-all-query.html "ES match all query"
[18]: https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html "ES term level query"
[19]: https://elkguide.elasticsearch.cn/ "ELK Stack 中文指南"
[20]: https://www.elastic.co/guide/en/elasticsearch/reference/7.1/sql-syntax-select.html "SQL查询"
[21]: https://www.elastic.co/guide/index.html "es官网文档"
[22]: https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html#multi-fields [multi-fields]
