---
layout: default
title:  ansible的使用
author: lijiaocn
createdate: 2018/03/12 15:43:00
changedate: 2018/03/12 18:03:46
categories: 技巧
tags: ansible
keywords:
description: ansible是一个常用的运维管理工具。

---

* auto-gen TOC:
{:toc}

## 说明

ansible是一个常用的运维管理工具。[ansible documents][1]

## host管理

通过ansible管理的机器默认记录在`/etc/ansible/hosts`文件中，可以用`-i`指定另外的hosts文件。

hosts文件记录了所有的目标机器，以及它们的分组信息，例如：

	mail.example.com   <--- 机器列表
	
	[webservers]       <--- group名称
	foo.example.com
	bar.example.com
	
	[dbservers]
	one.example.com
	two.example.com
	three.example.com
	badwolf.example.com:5309                           <--可以指定ssh端口，默认是22
	jumper ansible_port=5555 ansible_host=192.0.2.50   <--可以设置别名

hosts文件可以是上面所示的ini格式，也可以是yaml格式：

	all:
	  hosts:
	    mail.example.com
	  children:
	    webservers:
	      hosts:
	        foo.example.com:
	        bar.example.com:
	    dbservers:
	      hosts:
	        one.example.com:
	        two.example.com:
	        three.example.com:

使用yaml设置别名的格式如下：

	hosts:
	  jumper:
	    ansible_port: 5555
	    ansible_host: 192.0.2.50

如果host名称类似，可以使用下面的模式：

	[webservers]
	www[01:50].example.com
	
	[databases]
	db-[a:f].example.com

还可以分别指定连接类型和用户名：

	[targets]
	
	localhost              ansible_connection=local
	other1.example.com     ansible_connection=ssh        ansible_user=mpdehaan
	other2.example.com     ansible_connection=ssh        ansible_user=mdehaan

可以为每个host设置变量：

	[atlanta]
	host1 http_port=80 maxRequestsPerChild=808
	host2 http_port=303 maxRequestsPerChild=909

## group管理

默认有`all`和`ungrouped`两个group，all包括所有的host，`ungrouped`是`只在all`中的host。

可以将group再打包成一个group，使用`:children`后缀：

	[atlanta]
	host1
	host2
	
	[raleigh]
	host2
	host3
	
	[southeast:children]
	atlanta
	raleigh

也可以为整个group设置变量，使用后缀`:vars`：

	[atlanta]
	host1
	host2
	
	[atlanta:vars]
	ntp_server=ntp.atlanta.example.com
	proxy=proxy.atlanta.example.com

## 变量管理

可以将host变量和group变量拆分到`group_vars`目录和`host_vars`目录中，与group或者host同名的文件中：

	/etc/ansible/group_vars/raleigh 
	/etc/ansible/group_vars/webservers
	/etc/ansible/host_vars/foosball

如果不使用默认路径，`group_vars`和`host_vars`应当与hosts文件位于同一个目录中。

变量文件使用yaml格式，如下:

	---
	ntp_server: acme.example.org
	database_server: storage.example.org

也可以在与group和host同名的目录中，创建多个变量文件，需要1.4及以上版本：

	/etc/ansible/group_vars/raleigh/db_settings
	/etc/ansible/group_vars/raleigh/cluster_settings

ansible定义以下这些有特殊含义的变量：

	ansible_connection       //可以是local、docker、smart、ssh、paramiko
	ansible_host
	ansible_port
	ansible_user
	ansible_ssh_pass
	ansible_ssh_private_key_file
	ansible_ssh_common_args
	ansible_sftp_extra_args
	ansible_scp_extra_args
	ansible_ssh_extra_args
	ansible_ssh_pipelining
	ansible_ssh_executable (added in version 2.2)
	ansible_become
	ansible_become_method
	ansible_become_user
	ansible_become_pass
	ansible_become_exe
	ansible_become_flags
	ansible_shell_type
	ansible_python_interpreter
	ansible_*_interpreter
	ansible_shell_executable

## 动态获取

host和group信息还可以从其它系统中动态的获取，[ansible Dynamic Inventory][2]。

## playbook

ansible可以根据playbook文件中的描述，对一组机器进行一系列的操作。



## 参考

1. [ansible documents][1]
2. [ansible Dynamic Inventory][2]

[1]: https://docs.ansible.com/ansible/latest/intro_installation.html  "ansible documents" 
[2]: https://docs.ansible.com/ansible/latest/intro_dynamic_inventory.html "ansible Dynamic Inventory"
