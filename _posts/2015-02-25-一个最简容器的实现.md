---
layout: default
title: 一个最简容器的实现
author: 李佶澳
createdate: 2017/07/14 14:46:49
changedate: 2017/07/14 14:54:08
categories: 技巧
tags: namespace
keywords: Kernel,namespace,container,ns
description:  Kernel的namespace功能特性的出现, 使容器的实现更为简单。

---

* auto-gen TOC:
{:toc}

## 摘要

在云化的时代大背景下，docker的出现带火了容器技术。Kernel的namespace功能特性的出现, 使容器的实现更为简单。

这里是一个最简单的例子。

## 源码

[simple_container](https://github.com/lijiaocn/LinuxC/tree/master/simple_container)

## 过程

在开始之前, 需要先了解[namespace](http://lwn.net/Articles/531114/)。

准备容器的image. 我们暂时只需要一个bash, 使用yum安装到rootfiles目录。

>社区提出了一个[App Container Spec](https://github.com/appc/spec/)。当然我们这只是最简单的实现，没有考虑符合标准。

	#!/bin/bash
	 
	if [[ ! $# -eq 1 ]]
	then
		echo "usage: $0 directory"
		exit
	fi
	 
	LOCPATH=`pwd`
	 
	DstDir="${LOCPATH}/$1"
	 
	echo "The Dst Path is: %DstDir [any key continue]"
	read
	 
	yum install --installroot=$DstDir -y rootfiles
	yum install --installroot=$DstDir -y bash

编写我们自己的容器[code](https://github.com/lijiaocn/LinuxC/blob/master/simple_container/LiKer.c)

我们只需要使用clone创建namespace, 然后在这个namespace中执行chroot, 将根文件系统换成我们准备的image。

运行

	[root@localhost bin]# ./Liker  ../rootfs/      # rootfs是我们准备的images
	[root@localhost /]# alias                      # 这时候已经处于我们自己的容器中了！注意当前路径已经切换到了/
	alias cp='cp -i'
	alias mv='mv -i'
	alias rm='rm -i'
	[root@localhost /]# exit                       # 退出容器
	exit
	Finished!
	[root@localhost bin]# 

这虽然只是一个简单的namespace的使用, 但是却可以使容器技术不再显得那么神秘。

## 扩展1 -- 资源控制

通过namespace达到了隔离容器的目录, 在资源使用上，容器和宿主系统上的其它进程享有同样的待遇。如果一个容器申请了大量的资源（比如内存）, 必然会影响到其它进程的运行。 所以我们还需要限制一个容器能够使用的资源总量。使用cgroup可以达到此目的。

我们需要限制或保障以下内容:

	1. CPU， 容器可以使用的CPU核心与CPU时间，Cpusets、CPU Accounting Controller。
	2. 内存, 容器可以使用的内存, Memory Resource Controller。
	         容器可以使用的HugePage, HugeTLB Controller。
	3. 磁盘, 容器对磁盘IO的占用, Block IO Controller。
	4. 网络, 容器对带宽的占用，Network Classifier、Network Priority。
	5. 权限, 容器可以操作的设备, Device Whitelist Controller。

## 扩展2 -- Namespace细化

## 文献

1. [Linux内核技术](http://www.lijiaocn.com/blog/2014/06/30/Linux%E5%86%85%E6%A0%B8%E6%8A%80%E6%9C%AF.html)

2. [namespace](http://lwn.net/Articles/531114/)

3. [cgroups kernel document](https://www.kernel.org/doc/Documentation/cgroups/)
